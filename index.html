<html><head>
<link rel="shortcut icon" href="https://github.com/ggffggffjgff-svg/doctor/tree/main/img/icon.ico" type="image/x-icon" />
<TITLE>Доктрис</TITLE>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="keywords" content="доктор, доктрис, старая игра, canvas, канвас">
<script type="text/javascript"> 

var xOffs, yOffs;
var game = new game_constructor;

function start() {
setSize();
game.canvas.id = "mycanvas";
document.body.appendChild(game.canvas);
newPill();
newLevel();
if (document.body.firstElementChild.tagName == 'DIV') document.body.firstElementChild.style.display = "none";
}

function setSize(){
var w = window.innerWidth;
var h = window.innerHeight;
var offset = 0;
var cell;

if (w > h) {
  cell = parseInt(h/13);
  if (cell > parseInt(w/8)) cell = parseInt(w/8);
  }
else {
  cell = parseInt(w/8);
  if (cell > parseInt(h/13)) cell = parseInt(h/13);
  }
offset = parseInt(w/2 - 4*cell);
game.canvas.width = cell * 8;
game.canvas.height = cell * 13;
game.canvas.style.left = offset + "px";
var x = game.current_pill.x / game.cell;
var y = game.current_pill.y / game.cell;
game.current_pill.x = parseInt(x * cell);
game.current_pill.y = parseInt(y * cell);
x = game.next_pill.x / game.cell;
y = game.next_pill.y / game.cell;
game.next_pill.x = parseInt(x * cell);
game.next_pill.y = parseInt(y * cell);
game.cell = cell;
game.interval = parseInt((20000 - 1000 * game.level)/12/game.cell);
if (game.canvas.id == "mycanvas") draw();
}

function pill_constructor(){
 this.x = 0;
 this.y = 0;
 this.color = [0, 0];
 this.pos = 0;
}

function game_constructor(){
this.canvas = document.createElement('canvas');
this.canvas.addEventListener('mousedown', mousedown, false);
this.canvas.addEventListener('touchstart', startTouch, false);
this.canvas.addEventListener('touchend', stopTouch, false);
this.canvas.style = "background-color: #444444; position: absolute;";
this.nonote = document.createElement('img');
this.nonote.src = "img/nonote.png";
this.controlimg = document.createElement('img');
this.controlimg.src = "img/control.png";
this.item = document.createElement('img');
this.item.src = "img/item.png";
this.topimg = document.createElement('img');
this.topimg.src = "img/top.png";
this.player = document.createElement("audio");
this.level = 0;
this.virus = 0;
this.control = false;
this.pause = true;
this.interval = 0;
this.delpil = 0;
this.next_pill = new pill_constructor();
this.current_pill = new pill_constructor();
this.arr = [];
for (var i = 0; i < 8; i++){
	this.arr[i] = [];
	for (var ii = 0; ii < 12; ii++) this.arr[i][ii] = 0;
}
this.soundOn = 0;
this.sound = [];
for (var i = 1; i < 4; i++){
  this.sound[i] = "sound/00" + i + ".mp3";
}
this.zoom_timer = 0;
this.timer = 0;
this.animate_timer = 0;
}

function left(){
var cell = game.cell;
var arr = game.arr;
var cp = game.current_pill;
  if (game.pause) pauseplay();
  if (cp.y < cell) return;
  if (cp.x == 0) return;
  if (arr[cp.x / cell - 1][parseInt(cp.y / cell)] > 0) return;
  if (arr[cp.x / cell - 1][parseInt((cp.y + cell / 4) / cell) - 1] > 0) return;
  if (cp.pos == 1) {
    if (arr[cp.x / cell - 1][parseInt((cp.y + cell / 4) / cell) - 2] > 0) return;
  }
  cp.x = cp.x - cell;
  }

function right(){
var cell = game.cell;
var arr = game.arr;
var cp = game.current_pill;
  if (game.pause) pauseplay();
  if (cp.y < cell) return;
  if (cp.pos == 0){
    if (cp.x == 6 * cell) return;
	if (arr[cp.x / cell + 2][parseInt(cp.y / cell)] > 0) return;
	if (arr[cp.x / cell + 2][parseInt((cp.y + cell / 4) / cell) - 1] > 0) return;
  }
  else {
    if (cp.x == 7 * cell) return;
	if (arr[cp.x / cell + 1][parseInt(cp.y / cell)] > 0) return;
	if (arr[cp.x / cell + 1][parseInt(cp.y / cell) - 1] > 0) return;
	if (arr[cp.x / cell + 1][parseInt((cp.y + cell / 4) / cell) - 2] > 0) return;
  }
  cp.x = cp.x + cell;
  }  

function down(){
var cell = game.cell;
var arr = game.arr;
var cp = game.current_pill;
  if (game.pause) pauseplay();
  if (arr[cp.x / cell][parseInt(cp.y / cell + 1)] > 0) return;
  if ((cp.pos == 0)&&(arr[cp.x / cell + 1][parseInt(cp.y / cell + 1)] > 0)) return;
  if (cp.y % cell == 0) return;
  if (cp.y >= cell * 11) return;
  if (cp.y < cell) return;
  cp.y = parseInt((cp.y / cell + 1) * cell);
  }

function rotate(){
var cell = game.cell;
var arr = game.arr;
var cp = game.current_pill;
  if (game.pause) pauseplay();
  if (cp.pos == 0) {
    if (arr[cp.x / cell][cp.y / cell - 1] > 0) return;
	if (cp.y / cell < 2) return;
    cp.pos = 1;
  }
  else {
	if ((cp.x / cell == 7)&&(arr[cp.x / cell - 1][parseInt(cp.y / cell)] == 0)){
	  cp.x -= cell;
	}
	if (arr[cp.x / cell + 1][parseInt(cp.y / cell)] > 0) return;
	if (arr[cp.x / cell + 1][parseInt((cp.y + cell / 4) / cell) - 1] > 0) return;
    cp.pos = cp.color[0];
	cp.color[0] = cp.color[1];
	cp.color[1] = cp.pos;
	cp.pos = 0;
  }
  }

function pauseplay(){
if (game.pause){
  game.pause = false;
  game.control = false;
  clearInterval(game.timer);
  game.timer = setInterval(go, game.interval);
}
else game.pause = true;
}

function mousedown(evm){
var x = evm.offsetX;
var y = evm.offsetY;
if (y < game.cell){
  if (x < game.cell) {
    pauseplaysound();
    draw();
  }
  if ((x > 6 * game.cell)&&(x < 7 * game.cell)){
    var result = confirm("New game?");
	if (result){
		game.level = 0;
		newLevel();
	}
  }
  if (x > 7 * game.cell) {
    game.pause = true;
	game.control = true;
	draw();
  }
  return;
}
pauseplay();
draw();
}

function startTouch(evt) {
evt.preventDefault();
var evList = evt.touches;
if (evList.length == 1){
  xOffs = evList[0].pageX;
  yOffs = evList[0].pageY;
}
else return false;
}

function stopTouch(evt) {
evt.preventDefault();
var evList = evt.changedTouches;
var x, y, dx, dy;
var cell = game.cell;
x = evList[0].pageX;
y = evList[0].pageY;
dx = x - xOffs;
dy = y - yOffs;
x -= parseInt(game.canvas.style.left);
if (y < cell){
  if (x < cell) {
    pauseplaysound();
    draw();
  }
  if ((x > 6 * cell)&&(x < 7 * cell)){
    var result = confirm("New game?");
	if (result){
		game.level = 0;
		newLevel();
	}
  }
  if (x > 7 * cell) {
    game.pause = true;
	game.control = true;
	draw();
  }
  return;
}
if ((Math.abs(dx) < cell)&&(Math.abs(dy) < cell)) {
  pauseplay();
  return;
}
if (Math.abs(dx) > Math.abs(dy)){
  if (dx > 0){
    right();
  }
  else {
    left();
  }
}
else {
  if (dy > 0){
    down();
  }
  else {
    rotate();
  }
}
}

function resize(){
    clearTimeout(game.zoom_timer);
    game.zoom_timer = setTimeout(setSize, 500);
}

function pauseplaysound(){
if (game.soundOn){
  game.soundOn = false;
}
else {
  game.soundOn = true;
  game.player.src = game.sound[1];
  game.player.play();
}
}

function newPill(){
testGameOver();
game.current_pill.color[0] = game.next_pill.color[0];
game.current_pill.color[1] = game.next_pill.color[1];
game.next_pill.color[0] = 1 + parseInt(3 * Math.random());
game.next_pill.color[1] = 1 + parseInt(3 * Math.random());
game.next_pill.x = 0;
game.next_pill.y = 0;
game.current_pill.x = 3 * game.cell;
game.current_pill.y = 0;
game.current_pill.pos = 0;
if (game.current_pill.color[0] > 0){
  clearInterval(game.timer);
  clearInterval(game.animate_timer);
  game.animate_timer = setInterval(moveNextPillDown, 150);
}
}

function moveNextPillDown(){
game.current_pill.y += parseInt(game.cell / 3);
if (game.current_pill.y >= game.cell){
  game.current_pill.y = game.cell;
  clearInterval(game.animate_timer);
  game.animate_timer = setInterval(moveNextPillRight, 150);
  }
draw();
}

function moveNextPillRight(){
game.next_pill.x += parseInt(2 * game.cell / 3);
if (game.next_pill.x >= 3 * game.cell){
  game.next_pill.x = 3 * game.cell;
  clearInterval(game.animate_timer);
  clearInterval(game.timer);
  game.timer = setInterval(go, game.interval);
  }
draw();
}

function testGameOver(){
var arr = game.arr;
if ((arr[3][0] > 0)||(arr[4][0] > 0)) {
  if (game.soundOn){
    game.player.src = game.sound[3];
	game.player.play();
  }
  game.level--;
  newLevel();
}
}

function draw(){
var c = game.canvas.getContext("2d");
var cell = game.cell;
var arr = game.arr;
var cp = game.current_pill;
var np = game.next_pill;
c.clearRect(0, 0, 8 * cell, 13 * cell);
if (game.control) {
  c.drawImage(game.controlimg, 0, 0, 8 * cell, 13 * cell);
  return;
}
for (var i = 0; i < 8; i++){
	for (var ii = 0; ii < 12; ii++){
       var iii = arr[i][ii] - 1;
	   if (iii >= 0) c.drawImage(game.item, iii * 130, 0, 130, 130, i*cell, (1+ii)*cell, cell, cell);
	}
}
c.drawImage(game.item, (np.color[0] + 2) * 130, 0, 130, 130, np.x, 0, cell, cell);
c.drawImage(game.item, (np.color[1] + 8) * 130, 0, 130, 130, np.x + cell, 0, cell, cell);
c.drawImage(game.item, (cp.color[0] + 2 + cp.pos * 9) * 130, 0, 130, 130, cp.x, cp.y, cell, cell);
c.drawImage(game.item, (cp.color[1] + 8 - cp.pos * 3) * 130, 0, 130, 130, cp.x + cell - cp.pos * cell, cp.y - cp.pos * cell, cell, cell);
c.drawImage(game.topimg, 0, 0, 8 * cell, cell);
if (! game.soundOn) c.drawImage(game.nonote, 0, 0, cell, cell);
}

function newLevel(){
game.pause = true;
var x, y;
var arr = game.arr;
game.level++;
game.virus = 3 * game.level;
var maxTop = game.level;
if (maxTop < 5) maxTop = 5;
if (maxTop > 11) maxTop = 11;
game.interval = parseInt((20000 - 1000 * game.level)/12/game.cell);
for (var i = 0; i < 8; i++){
	for (var ii = 0; ii < 12; ii++){
		arr[i][ii] = 0;
}}
for (var i = 1; i < 4; i++){
  for (var ii = 0; ii < game.level; ii++){
    var success = false;
	while (! success){
	  x = parseInt(8 * Math.random());
	  y = parseInt(maxTop * Math.random());
	  if (arr[x][11 - y] == 0) {
	    arr[x][11 - y] = i + 21;
		success = true;
	  }
	}
  }
}
newPill();
draw();
}

function go(){
if (game.pause){
  clearInterval(game.timer);
  return;
}
var success = false;
var arr = game.arr;
var cp = game.current_pill;
var cell = game.cell;
if (cp.y % cell == 0){
  if (cp.pos == 0){
	if ((cp.y / cell > 11) || (arr[cp.x / cell][cp.y / cell] > 0) || (arr[cp.x / cell + 1][cp.y / cell] > 0)){
	  arr[cp.x / cell][cp.y / cell - 1] = cp.color[0] + 3;
	  arr[cp.x / cell + 1][cp.y / cell - 1] = cp.color[1] + 9;
	  success = true;
	}
  }
  else {
    if ((cp.y / cell > 11) || (arr[cp.x / cell][cp.y / cell] > 0)){
	  arr[cp.x / cell][cp.y / cell - 1] = cp.color[0] + 12;
	  arr[cp.x / cell][cp.y / cell - 2] = cp.color[1] + 6;
	  success = true;
	}
  }
}
draw();
if (success){
	  clearInterval(game.timer);
	  _delete();
}
cp.y++;
}

function boom(){
var arr = game.arr;
for (var i = 0; i < 8; i++){
	for (var ii = 0; ii < 12; ii++){
	  if (arr[i][ii] == game.delpil) arr[i][ii]++;
	  if (arr[i][ii] == 21) arr[i][ii] = 0;
	}
}
draw();
game.delpil++;
if (game.delpil >= 21){
  clearInterval(game.animate_timer);
  game.animate_timer = setInterval(downPill, 150);
}
}

function downPill(){
var arr = game.arr;
var success = false;
for (var i = 0; i < 8; i++){
  for (var ii = 11; ii >= 0; ii--){
    switch(arr[i][ii]){
	case 1:
	case 2:
	case 3:
      if (arr[i][ii + 1] == 0){
        arr[i][ii + 1] = arr[i][ii];
        arr[i][ii] = 0;
        success = true;
      }
	  break;
	case 4:
	case 5:
	case 6:
	  if ((arr[i][ii + 1] == 0)&&(arr[i + 1][ii + 1] == 0)){
        arr[i][ii + 1] = arr[i][ii];
        arr[i][ii] = 0;
		arr[i + 1][ii + 1] = arr[i + 1][ii];
        arr[i + 1][ii] = 0;
        success = true;
      }
	  break;
	case 13:
	case 14:
	case 15:
	  if (arr[i][ii + 1] == 0){
        arr[i][ii + 1] = arr[i][ii];
        arr[i][ii] = arr[i][ii - 1];
		arr[i][ii - 1] = 0;
        success = true;
      }
	  break;
	}
  }
}
draw();
if (! success) {
  clearInterval(game.animate_timer);
  _delete();
}
}

function _delete(){
var arr = game.arr;
var success = false;
var del = [];
var i, ii;
for (i = 0; i < 8; i++){
	del[i] = [];
	for (ii = 0; ii < 12; ii++){
		del[i][ii] = 0;
}}
i = 0;
var count = 0;
while (i < 8) {
ii = 0;
  while (ii < 9) {
    count = 0;
    if (arr[i][ii] > 0) count = compareV(i, ii);
	if (count > 2) {
	  success = true;
	  for (var iii = ii; iii <= (ii + count); iii++){
	    del[i][iii] = 1;
	  }
	}
	if (count > 0) ii += count;
	else ii ++;
  }
  i++;
}
i = 0;
while (i < 12) {
ii = 0;
  while (ii < 5) {
    count = 0;
    if (arr[ii][i] > 0) count = compareG(ii, i);
	if (count > 2) {
	  success = true;
	  for (var iii = ii; iii <= (ii + count); iii++){
	    del[iii][i] = 1;
	  }
	}
	if (count > 0) ii += count;
	else ii ++;
  }
  i++;
}
if (success){
if (game.soundOn) {
  game.player.src = game.sound[1];
  game.player.play();
}
for (i = 0; i < 8; i++){
	for (ii = 0; ii < 12; ii++){
		if (del[i][ii] == 1) {
		  switch(arr[i][ii]){
		  case 4:
		  case 5:
		  case 6:
		    arr[i + 1][ii] = arr[i + 1][ii] - 9;
			break;
		  case 7:
		  case 8:
		  case 9:
		    arr[i][ii + 1] = arr[i][ii + 1] - 12;
			break;
		  case 10:
		  case 11:
		  case 12:
		    arr[i - 1][ii] = arr[i - 1][ii] - 3;
			break;
		  case 13:
		  case 14:
		  case 15:
		    arr[i][ii - 1] = arr[i][ii - 1] - 6;
			break;
		  }
		  if (arr[i][ii] > 20) game.virus--;
		  arr[i][ii] = 16;
		}
}}  
}
if (success){ 
  game.delpil = 16;
  game.current_pill.x = 0;
  game.current_pill.y = -5;
  game.current_pill.pos = 0;
  clearInterval(game.animate_timer);
  game.animate_timer = setInterval(boom, 100);
}
else {
  if (game.virus == 0){
    if (game.soundOn) {
	  game.player.src = game.sound[2];
	  game.player.play();
	}
	newLevel();
  }
  else {
    newPill();
  }
}
function compareV(i, ii){
var count = 0;
while (ii < 11) {
  if ((arr[i][ii] > 0)&&(arr[i][ii + 1] > 0)&&((arr[i][ii] % 3) == (arr[i][ii + 1] % 3))) {
    count++;
	ii++;
  }
  else {
    break;
  }
}
return count;
}

function compareG(i, ii){
var count = 0;
while (i < 7) {
  if ((arr[i][ii] > 0)&&(arr[i + 1][ii] > 0)&&((arr[i][ii] % 3) == (arr[i + 1][ii] % 3))) {
    count++;
	i++;
  }
  else {
    break;
  }
}
return count;
}
}

document.onkeydown = function checkKeycode(event)
{
	var keycode;
	if(!event) var event = window.event;
	else if(event.which) keycode = event.which;
	switch(keycode){
	case 37:
	case 65:
	  left();
	  break;
	case 39:
	case 68:
	  right();
	  break;
	case 38:
	case 87:
	  rotate();
	  break;
	case 40:
	case 83:
	  down();
	  break;
	case 32:
	  pauseplay();
	}
}

</script> 
</head>
<body onload="start();" onresize="resize();" style="margin: 0; padding: 0; background-color: #000000">
</body>
</html>
